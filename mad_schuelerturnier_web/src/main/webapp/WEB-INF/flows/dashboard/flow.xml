<?xml version="1.0" encoding="UTF-8"?>
<!--suppress ALL -->
<flow xmlns="http://www.springframework.org/schema/webflow"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:schemaLocation="http://www.springframework.org/schema/webflow http://www.springframework.org/schema/webflow/spring-webflow-2.0.xsd">

    <action-state id="initialisieren">
        <evaluate expression="loginPrepareAction.execute()"/>
        <evaluate expression="startAction.start(currentUser)"/>
    </action-state>

    <view-state id="dashboard">

    </view-state>

    <view-state id="user">
    </view-state>

    <action-state id="newmannschaft">
        <on-entry>
            <evaluate expression="modelFactory.getInstance('com.googlecode.madschuelerturnier.model.Mannschaft')"
                      result="flowScope.mannschaftBean"/>
        </on-entry>
        <evaluate expression="modelFactory.ok()"/>
        <transition on="ok" to="newmannschaft_view"/>
    </action-state>

    <view-state id="newmannschaft_view" view="mannschaft/new.xhtml" model="mannschaftBean">
        <transition on="save" to="mannschaftsliste" bind="true">
            <evaluate expression="mannschaftRepository.save(mannschaftBean)"/>
        </transition>
    </view-state>


    <view-state id="initialisieren_view" view="initialisieren.xhtml">
        <transition on="save" to="initialisieren">

            <evaluate expression="business.initializeDB()"/>


        </transition>

    </view-state>

    <view-state id="mannschaftsliste" view="mannschaft/liste.xhtml" redirect="true">
        <on-entry>
            <evaluate expression="business.getMannschaften()" result="flowScope.mannschaftList"/>
        </on-entry>
        <transition on="newmannschaft_view" to="newmannschaft_view">
            <evaluate expression="mannschaftRepositoryDelegate.findOne(requestParameters.id)"
                      result="flowScope.mannschaftBean"/>
        </transition>
    </view-state>

    <view-state id="mannschaftslisteExport" view="mannschaft/liste_export.xhtml"
                redirect="true">
        <on-entry>

            <evaluate expression="business.getMannschaften()" result="flowScope.mannschaftList"/>
        </on-entry>
        <transition on="newmannschaft_view" to="newmannschaft_view">
            <evaluate
                    expression="mannschaftRepositoryDelegate.findOne(requestParameters.id)"
                    result="flowScope.mannschaftBean"/>
        </transition>
    </view-state>

    <view-state id="mannschaftslisteImport" view="mannschaft/liste_import.xhtml"
                redirect="true">
        <transition on="submit" to="mannschaftsliste">
            <evaluate expression="fileUploadAction"></evaluate>
        </transition>
    </view-state>

    <view-state id="spielsteuerung" view="spielsteuerung/admin.xhtml"
                redirect="true">
        <transition on="go" to="spielsteuerung">
            <evaluate expression="spielstatusWebBean.shiftSpielPhase()"/>
        </transition>

        <transition on="testmannschaften2012" to="spielsteuerung">
            <evaluate expression="dataGenerator.insertMannschaften('2012')"/>
        </transition>
        <transition on="testmannschaften2011" to="spielsteuerung">
            <evaluate expression="dataGenerator.insertMannschaften('2011')"/>

        </transition>
        <transition on="testdatenreset" to="spielsteuerung">
            <evaluate expression="dataGenerator.resetTestdata()"/>

        </transition>
    </view-state>

    <view-state id="kategorien" view="mannschaft/kategorien.xhtml"
                redirect="true">
        <transition on="mannschaft_verschieben" to="mannschaft_verschieben"/>

        <transition on="spielwunsch_eintragen" to="spielwunsch_eintragen"/>
    </view-state>

    <action-state id="mannschaft_verschieben">
        <evaluate expression="kategorieZuordnungsAction"/>

    </action-state>

    <action-state id="spielwunsch_eintragen">
        <evaluate expression="spielwunschAction"/>
        <transition on="kategorien" to="kategorien"/>
    </action-state>


    <view-state id="spieleinstellungen" view="spielsteuerung/spieltage.xhtml"
                model="flowScope.spieleinstellungen">
        <on-entry>

            <set name="flashScope.tr" value="true" type="java.lang.Boolean"/>
            <set name="flashScope.fa" value="false" type="java.lang.Boolean"/>
            <evaluate expression="business.getSpielzeilen(flashScope.fa)"
                      result="flowScope.spielZeilenSa"/>
            <evaluate expression="business.getSpielzeilen(flashScope.tr)"
                      result="flowScope.spielZeilenSo"/>
        </on-entry>

        <transition on="save" to="spieleinstellungen" bind="true">
            <set name="flashScope.tr" value="true" type="java.lang.Boolean"/>
            <set name="flashScope.fa" value="false" type="java.lang.Boolean"/>
            <evaluate expression="business.saveEinstellungen(flowScope.spieleinstellungen)"
                      result="flowScope.spieleinstellungen"/>
            <evaluate expression="business.initZeilen(flashScope.fa)"
                      result="flowScope.spielZeilenSa"/>
            <evaluate expression="business.initZeilen(flashScope.tr)"
                      result="flowScope.spielZeilenSo"/>
        </transition>

        <transition on="man" to="spieleinstellungen" bind="true">
            <evaluate expression="business.saveEinstellungen(flowScope.spieleinstellungen)"/>
            <evaluate expression="f6SpielverteilerManuelleKorrekturen.korrekturenVornehmen()"/>
        </transition>

        <transition on="toggleP" to="tagaktivieren" bind="true">

        </transition>

    </view-state>

    <action-state id="tagaktivieren">
        <evaluate expression="tagToggleAction"/>

        <transition on="weiter" to="spieleinstellungen"/>
    </action-state>

    <action-state id="speaker_reload_action">

        <on-entry>
            <set name="flowScope.outcome" value="true" type="java.lang.String"/>
        </on-entry>
        <evaluate expression="business.anstehendePenalty()" result="flowScope.penaltyAnstehend"/>
        <evaluate expression="spielDurchfuehrung.getWait()" result="flowScope.wait"/>
        <evaluate expression="spielDurchfuehrung.getText()" result="flowScope.speak"/>

        <evaluate expression="speakerReloadAction"/>


        <transition on="speaker_view" to="speaker_view"/>

    </action-state>


    <view-state id="speaker_view" view="durchfuehrung/speaker.xhtml">

        <on-render>
            <evaluate expression="business.getSpielEinstellungen()"
                      result="flowScope.spieleinstellungen"/>
        </on-render>

        <transition on="vorbereitet" to="speaker_reload_action">
            <evaluate expression="spielDurchfuehrung.vorbereitet()"/>
        </transition>

        <transition on="refresh" to="speaker_reload_action" history="invalidate">

        </transition>

        <transition on="spielen" to="speaker_reload_action" history="invalidate">
            <evaluate expression="spielDurchfuehrung.spielen()"/>
        </transition>

        <transition on="beenden" to="speaker_reload_action">
            <evaluate expression="spielDurchfuehrung.beenden()"/>
        </transition>

    </view-state>

    <view-state id="spiel_start" view="durchfuehrung/spiel_start.xhtml" redirect="true"
                model="flowScope.spieleinstellungen">

        <on-render>
            <evaluate expression="business.saveEinstellungen(flowScope.spieleinstellungen)"/>
            <evaluate expression="business.getSpielEinstellungen()"
                      result="flowScope.spieleinstellungen"/>
        </on-render>

        <transition on="start" to="spiel_start" bind="true">
            <evaluate expression="business.saveEinstellungen(flowScope.spieleinstellungen)"/>
            <evaluate expression="business.startClock()"/>
            <evaluate expression="business.getSpielEinstellungen()"
                      result="flowScope.spieleinstellungen"/>
        </transition>
        <transition on="stop" to="spiel_start" bind="true">
            <evaluate expression="business.saveEinstellungen(flowScope.spieleinstellungen)"/>
            <evaluate expression="business.stopClock()"/>
        </transition>


    </view-state>

    <view-state id="eintrager" view="durchfuehrung/eintrager.xhtml" redirect="true">

        <on-render>
            <evaluate expression="business.anstehendePenalty()" result="flowScope.penaltyAnstehend"/>
            <evaluate expression="spielRepositoryDelegate.findAllEinzutragende()"
                      result="flowScope.einzutragende"/>
        </on-render>

        <transition on="zuweisen" to="eintrager">
            <evaluate expression="pictureAgent.zuweisen()"/>
        </transition>

        <transition on="save" to="eintrager">
            <evaluate expression="spielRepositoryDelegate.eintragen(flowScope.einzutragende,requestParameters.id)"/>
            <evaluate expression="spielRepositoryDelegate.findAllEinzutragende()"
                      result="flowScope.einzutragende"/>
        </transition>
        <transition on="saveP" to="eintrager">
            <evaluate expression="business.penaltyEintragen(flowScope.penaltyAnstehend)"/>
        </transition>
    </view-state>


    <view-state id="v_historie" view="beobachter/historie.xhtml" redirect="true">

    </view-state>

    <view-state id="v_matrix" view="beobachter/matrix.xhtml" redirect="true">

    </view-state>

    <view-state id="v_schiri" view="beobachter/schiri.xhtml" redirect="true">

    </view-state>

    <view-state id="v_rangliste" view="beobachter/rangliste.xhtml" redirect="true">

    </view-state>

    <view-state id="import-export" view="mannschaft/import-export.xhtml" redirect="true"/>


    <view-state id="kontrollierer" view="durchfuehrung/kontrollierer.xhtml" redirect="true">


        <on-render>
            <evaluate expression="spielRepositoryDelegate.findAllZuBestaetigen()"
                      result="flowScope.bestaetigen"/>
        </on-render>


        <transition on="save" to="kontrollierer">
            <evaluate
                    expression="spielRepositoryDelegate.bestaetigen(flowScope.bestaetigen,requestParameters.id,requestParameters.ok)"/>
            <evaluate expression="spielRepositoryDelegate.findAllZuBestaetigen()"
                      result="flowScope.bestaetigen"/>

        </transition>
    </view-state>

    <view-state id="korrekturen" view="mannschaft/korrekturen.xhtml" redirect="true" model="korrekturen">
        <transition on="save" to="korrekturen" bind="true">
            <evaluate expression="business.saveEinstellungen(flowScope.korrekturen)"/>
        </transition>
    </view-state>

    <view-state id="resultatekorrekturen" view="mannschaft/korrekturen.xhtml" redirect="true" model="korrekturen">
        <transition on="save" to="korrekturen" bind="true">
            <evaluate expression="business.saveEinstellungen(flowScope.korrekturen)"/>
        </transition>
    </view-state>


    <view-state id="liste_spiel" view="root/liste_spiel.xhtml" redirect="true">
        <transition on="show" to="edit_spiel">
            <evaluate expression="spielServiceImpl.findSpiel(requestParameters.id)" result="flowScope.spiel"/>
        </transition>
    </view-state>

    <view-state id="edit_spiel" view="root/edit_spiel.xhtml" redirect="true" model="spiel">
        <transition on="save" to="liste_spiel" bind="true">
            <evaluate expression="spielServiceImpl.doKorrektur(spiel)"/>
        </transition>
    </view-state>


    <global-transitions>

        <transition on="initialisieren" to="initialisieren_view">

        </transition>

        <transition on="dashboard" to="dashboard"/>
        <transition on="newmannschaft" to="newmannschaft"/>
        <transition on="user" to="user"/>
        <transition on="mannschaftsliste" to="mannschaftsliste"/>
        <transition on="mannschaftslisteExport" to="mannschaftslisteExport"/>
        <transition on="mannschaftslisteImport" to="mannschaftslisteImport"/>

        <transition on="gt_historie" to="v_historie"/>
        <transition on="gt_matrix" to="v_matrix"/>
        <transition on="gt_schiri" to="v_schiri"/>
        <transition on="gt_rangliste" to="v_rangliste"/>

        <transition on="gt_resultatekorrekturen" to="liste_spiel">
            <evaluate expression="spielServiceImpl.readAllSpiele()" result="flowScope.spiele"/>
        </transition>


        <transition on="import-export" to="import-export"/>

        <transition on="korrekturen" to="korrekturen">
            <evaluate expression="business.getSpielEinstellungen()"
                      result="flowScope.korrekturen"/>
        </transition>

        <transition on="spieleinstellungen" to="spieleinstellungen">
            <evaluate expression="business.getSpielEinstellungen()"
                      result="flowScope.spieleinstellungen"/>
        </transition>


        <transition on="spielsteuerung" to="spielsteuerung"/>

        <transition on="kategorien_m" to="kategorien">
            <evaluate expression="business.getKategorienMList()" result="flowScope.kategorien"/>
        </transition>

        <transition on="kategorien_k" to="kategorien">
            <evaluate expression="business.getKategorienKList()" result="flowScope.kategorien"/>
        </transition>

        <transition on="speaker" to="speaker_reload_action"/>

        <transition on="spiel_start" to="spiel_start">
            <evaluate expression="business.getSpielEinstellungen()"
                      result="flowScope.spieleinstellungen"/>
        </transition>

        <transition on="eintrager" to="eintrager">
            <evaluate expression="spielRepositoryDelegate.findAllEinzutragende()"
                      result="flowScope.einzutragende"/>

        </transition>


        <transition on="kontrollierer" to="kontrollierer">
            <evaluate expression="spielRepositoryDelegate.findAllZuBestaetigen()"
                      result="flowScope.bestaetigen"/>


        </transition>


    </global-transitions>

</flow>